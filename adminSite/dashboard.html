<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="assets/img/nur.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Universidad Nur</title>

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="../assets/sweetalert2/sweetalert2.min.css">

    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Animation library for notifications   -->
    <link href="assets/css/animate.min.css" rel="stylesheet" />

    <!--  Light Bootstrap Table core CSS    -->
    <link href="assets/css/light-bootstrap-dashboard.css?v=1.4.0" rel="stylesheet" />


    <!--  CSS for Demo Purpose, don't include it in your project     -->
    <!--     Fonts and icons     -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
    <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />
    <link href="assets/css/all.css" rel="stylesheet" />
    <style>
        /* Center the loader */
        
        .loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }
        
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Add animation to "page content" */
        
        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }
        
        @-webkit-keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0px;
                opacity: 1
            }
        }
        
        @keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0;
                opacity: 1
            }
        }
        
        #myDiv {
            display: none;
            text-align: center;
        }
        
        .dropdown-item {
            display: block;
            width: 100%;
            /* padding: .25rem 1.5rem; */
            clear: both;
            font-weight: 400;
            color: #212529;
            text-align: inherit;
            white-space: nowrap;
            /* background: 0 0; */
            /* border: 0; */
            padding: 8px 16px;
            color: #333333;
            font-size: 16px;
        }
        
        @media (max-width: 991px) {
            .nav-mobile-menu .dropdown .dropdown-menu .dropdown-item {
                border-radius: 4px;
                color: #FFFFFF;
                opacity: .86;
                padding: 8px 50px;
            }
        }
        
        .sidebar .nav .nav-link,
        body>.navbar-collapse .nav .nav-link {
            color: #FFFFFF;
            margin: 5px 15px;
            opacity: .86;
            border-radius: 4px;
            text-transform: uppercase;
            line-height: 30px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .sidebar .nav span {
            margin: 0;
            line-height: 30px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 45px;
        }
        
        .card .card-image img {
            width: 100%;
        }
        
        .card-user .card-image {
            height: 150px;
            overflow: hidden;
        }
        
        .card-user .avatar {
            border: 4px solid #FFFFFF;
            position: relative;
            margin-bottom: 15px;
        }
        
        @media (min-width: 992px) {
            .table-full-width {
                margin-left: 0px !important;
                margin-right: 0px !important;
            }
        }
        
        .input-group-addon {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }
        
        .panel-body {
            padding: 9px !important;
        }
        
        @media (max-width: 576px) {
            .card-user .card-image {
                height: 100px !important;
            }
        }
        
        @media (min-width: 992px) {
            #infoPersonal {
                height: 300px;
            }
        }
    </style>

</head>

<body>
    <input type="hidden" id="MasterPeriodoActual">
    <input type="hidden" id="hperiodoActual">
    <input type="hidden" id="dperiodoActual">
    <input type="hidden" id="isHistorialCargado" value="0">
    <input type="hidden" id="firstLoad" value="">
    <div id="mainLoader" class='loader'></div>
    <div id="mainContainer" class="wrapper" style="display:none">
        <div class="sidebar" data-color="purple">

            <!--
        Tip 1: you can change the color of the sidebar using: data-color="blue | azure | green | orange | red | purple"
        Tip 2: you can also add an image using data-image tag
    -->

            <div class="sidebar-wrapper">
                <div class="logo">
                    <ul class="nav">
                        <a href="" class="simple-text">
                            <img style="width:90%" src="assets/img/nur.png" alt="">
                        </a>

                    </ul>
                </div>

                <ul class="nav">
                    <!-- <div style=" padding: 10px 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                        <li class="active">
                            <select id="periodosOferta" style="width:100%;margin:auto;text-align: center" class="form-control m-5 " id="selectCarrera">
                            </select>
                        </li>
                        <li class="active-pro" style="margin-top: 20px;">
                            <a id="verOferta" href="javascript:void(0)">
                                <i class="pe-7s-look"></i>
                                <p>Ver Oferta</p>
                            </a>
                        </li>
                    </div> -->
                    <br>
                    <div style=" padding: 10px 15px">
                        <!-- <h4 style="margin-left: 23%;margin-top: 0px">Carreras</h4> -->
                        <li class="active">
                            <select id="carrerasAlumno" style="width:100%;margin:auto;text-align: center" class="form-control m-5 " id="selectCarrera">
                            </select>
                        </li>
                    </div>

                    <li id="periodosTitle">
                        <h3 id='titlePeriodos' style="margin-left: 23%">Periodos</h3>
                    </li>

                </ul>
            </div>
        </div>

        <div class="main-panel">
            <nav class="navbar navbar-default navbar-fixed">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigation-example-2">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <div style="float:left">
                            <p id="nombreEstudiante" class="navbar-brand" href="javascript:void(0)"></p><br>
                            <p id="periodoActual" class="navbar-brand" href="javascript:void(0)"></p>
                        </div>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li class="nav-item dropdown show">
                                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="no-icon">MÃ¡s opciones</span>
                                </a>
                                <div class="dropdown-menu show" aria-labelledby="navbarDropdownMenuLink">
                                    <a class="dropdown-item" href="javascript:void(0)" data-toggle="modal" data-target="#modalOferta" onclick="getElementById('bodyClick').click()">
                                        <p>Ver Oferta</p>
                                    </a>
                                    <a class="dropdown-item" id="botonHistorial" href="historial.html">
                                        <p>Ver Historial</p>
                                    </a>
                                    <a class="dropdown-item" id="botonHistorial" onclick="verHistorial()" href="javascript:void(0)">
                                            <p>GrÃ¡fico Historial</p>
                                        </a>
                                    <a class="dropdown-item" id="botonPerfil" onclick="verPerfil()" href="javascript:void(0)">
                                        <p>Ver Perfil</p>
                                    </a>
                                    <a class="dropdown-item" href="javascript:void(0)" data-toggle="modal" data-target="#modalCambiarPin" onclick="getElementById('bodyClick').click()">
                                        <p>Cambiar Pin</p>
                                    </a>
                                </div>
                            </li>
                            <li>
                                <a id="botonImprimir" href="horario.html">
                                    <p>Ver Horario</p>
                                </a>
                            </li>
                            <li>
                                <a id="logout" onclick="logout()" href="../index.html">
                                    <p>Salir</p>
                                </a>
                            </li>
                            <li class="separator hidden-lg hidden-md"></li>
                        </ul>
                    </div>
                    <!-- <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li class="nav-item">
                                <a href="#" class="nav-link" data-toggle="dropdown">
                                    <i class="nc-icon nc-palette"></i>
                                    <span class="d-lg-none">Dashboard</span>
                                </a>
                            </li>
                            <li>
                                <a id="botonImprimir" href="horario.html" target="_blank" style="font-size: 18px">
                                    <span>Ver Horario</span>
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0)" data-toggle="modal" data-target="#modalCambiarPin" style="font-size: 18px">
                                    Cambiar Pin
                                </a>
                            </li>
                            <li>
                                <a id="logout" href="../index.html" style="font-size: 18px">
                                    Salir
                                </a>
                            </li>
                            <li class="separator hidden-lg hidden-md"></li>
                        </ul>
                    </div> -->
                </div>
            </nav>
            <div id="loader" class='loader'></div>
            <div class="content">
                <div class="row" id='containerNotas'>
                    <div class="col-md-12">
                        <div class="card">
                            <div class="header">
                                <h4 class="title">Notas</h4>
                            </div>
                            <div class="content table-responsive table-full-width">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <th>SIGLA</th>
                                        <th>MATERIA</th>
                                        <th>GRUPO</th>
                                        <th>DOCENTE</th>
                                        <th>PAR1</th>
                                        <th>PAR2</th>
                                        <th>EX.FINAL</th>
                                        <th>N.FINAL</th>
                                    </thead>
                                    <tbody id="tablaNotas">

                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id="containerAsistencia">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="header">
                                <h4 class="title">Asistencia</h4>
                            </div>
                            <div class="content table-responsive table-full-width">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <th>SIGLA</th>
                                        <th>MATERIA</th>
                                        <th>GRUPO</th>
                                        <th>DOCENTE</th>
                                        <th class="secondSemester" style="display: none">AGO</th>
                                        <th class="secondSemester" style="display: none">SEP</th>
                                        <th class="secondSemester" style="display: none">OCT</th>
                                        <th class="secondSemester" style="display: none">NOV</th>
                                        <th class="secondSemester" style="display: none">DIC</th>

                                        <th class="firstSemester" style="display: none">MAR</th>
                                        <th class="firstSemester" style="display: none">ABR</th>
                                        <th class="firstSemester" style="display: none">MAY</th>
                                        <th class="firstSemester" style="display: none">JUN</th>
                                        <th class="firstSemester" style="display: none">JUL</th>

                                        <th class="verano" style="display: none">ENE</th>
                                        <th class="verano" style="display: none">FEB</th>
                                    </thead>
                                    <tbody id="tablaAsistencia">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id='containerPerfil' style="display:none">
                    <div class="col-md-6">
                        <div class="card card-user" style='border:none'>
                            <div class="card-image">
                                <img src="assets/img/beach.jpg" alt="No se pudo obtener la imagen">
                            </div>
                            <div class="card-body">
                                <div class="author">
                                    <a href="javascript:void(0)">
                                        <img id='imgUsuario' class="avatar border-gray" alt="No se pudo obtener la imagen">
                                        <h5 id='tituloNombreEstudiante' class="title"></h5>
                                        <p id='carreraPerfil' class="description">
                                        </p>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6" id='infoPersonal'>
                        <div class="card">
                            <div class="header">
                                <h4 class="title" style="float: left;">Informacion Personal</h4>
                            </div>
                            <br/>
                            <br/>
                            <div class="panel-body">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon">
                                                        <i class="fas fa-phone"></i>
                                                        Telefono
                                                </span>
                                    </span>
                                    <input id='inputTelefono' type="text" style="cursor:text" readonly="readonly" class="form-control" />
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="input-group input-group-lg">
                                    <span style='padding-right: 35px;' class="input-group-addon">
                                                <i class="fas fa-mobile-alt"></i>
                                                Celular
                                                    </span>
                                    </span>
                                    <input id='inputCelular' type="text" style="cursor:text" readonly="readonly" class="form-control" />
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="input-group input-group-lg">
                                    <span style='padding-right: 40px;' class="input-group-addon">
                                                <i class="far fa-envelope"></i>
                                                Email
                                                    </span>
                                    </span>
                                    <input id='inputEmail' type="text" style="cursor:text" readonly="readonly" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="header">
                                <h4 class="title" style="float: left;">Horas de Servicio</h4>
                            </div>
                            <div class="container-fluid" style="height:300px;">
                                <div id="divCreditos" style="height: 270px;">

                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row" id="containerPensul" style="display:none">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="header">
                                <h4 class="title" style="float: left;">Historial pÃ©nsum acadÃ©mico</h4>
                                <a id='closePensul' href="javascript:void(0)" style="color: #3498db;float: right;font-size: 30px;">
                                    <i class="far fa-times-circle"></i>
                                </a>
                                <br>
                                <div style="margin-top:20px">
                                    <div style="height:20px;width:20px;background-color: #757575;float: left;border-radius: 5px">
                                    </div>
                                    <p style="margin-left:30px">Materias faltantes</p>
                                </div>
                            </div>
                            <div class="container-fluid" style="overflow:auto;height:560px">
                                <div id="chartdiv" style="height: 640px;min-width: 3700px;">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id="containerDeuda" style="display:none">
                    <div class='col-md-12'>
                            <div class="card">
                            <div class="alert alert-danger" role="alert">
                                    <h2 class="alert-heading">Bloqueo por Deuda</h2>
                                    <p>Pase por planes de pago.</p>
                                  </div>
                                </div>
                    </div>
                        <!-- <div class="overlay"></div>
                    <div class="terminal">
                        <h1>Bloqueo por <span class="errorcode">Deuda</span></h1>
                        <p class="output">Pase por planes de pago para ver sus notas</Ã¼>
                      </div> -->
                     
                </div>
            </div>

        </div>
    </div>


    <div id="modalCambiarPin" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 style="float:left;font-weight: 450;color: #3498db" class="modal-title">Cambiar Pin</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                </div>
                <div class="modal-body">
                    <form id="formCambiarPin">
                        <div class="form-group">
                            <label for="pinAnterior">Pin Anterior</label>
                            <input type="password" class="form-control" id="pinAnterior" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevoPin">Nuevo Pin</label>
                            <input type="password" class="form-control" id="nuevoPin" required>
                        </div>
                        <div class="form-group">
                            <label for="repetirNuevoPin">Vuelve a escribir tu nuevo Pin</label>
                            <input type="password" class="form-control" id="repetirNuevoPin" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>

                    </form>
                </div>
            </div>
        </div>
    </div>



    <div id="modalOferta" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 style="float:left;font-weight: 450;color: #3498db" class="modal-title">Oferta de Materias</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                </div>
                <div class="modal-body">
                    <label>Selecciona un Periodo</label>
                    <select id="periodosOferta" style="width:100%;margin:auto;text-align: center;margin-bottom: 15px" class="form-control m-5 " id="selectCarrera">
                                </select>
                    <button id='verOferta' type="button" class="btn btn-primary">Ver Oferta</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>

                </div>
            </div>
        </div>
    </div>
</body>
<script src="assets/js/core.js" type="text/javascript"></script>
<script src="assets/js/charts.js" type="text/javascript"></script>
<script src="assets/js/animated.js" type="text/javascript"></script>
<!--   Core JS Files   -->
<script src="assets/js/jquery.3.2.1.min.js" type="text/javascript"></script>
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../assets/sweetalert2/sweetalert2.min.js"></script>
<script src="assets/js/site.js"></script>


<script type="text/javascript">
    var horasServicio = 120;

    function errorSesion() {
        localStorage.removeItem("token");
        var url = '../index.html'
        $(location).attr("href", url);
    }

    function removerAcentos(newStringComAcento) {
        var string = newStringComAcento;
        var mapaAcentosHex = {
            a: /[\xE0-\xE6]/g,
            A: /[\xC0-\xC6]/g,
            e: /[\xE8-\xEB]/g,
            E: /[\xC8-\xCB]/g,
            i: /[\xEC-\xEF]/g,
            I: /[\xCC-\xCF]/g,
            o: /[\xF2-\xF6]/g,
            O: /[\xD2-\xD6]/g,
            u: /[\xF9-\xFC]/g,
            U: /[\xD9-\xDC]/g,
            c: /\xE7/g,
            C: /\xC7/g,
            n: /\xF1/g,
            N: /\xD1/g
        };
        for (var letra in mapaAcentosHex) {
            var expressaoRegular = mapaAcentosHex[letra];
            string = string.replace(expressaoRegular, letra);
        }
        return string;
    }

    function comenzarCargado() {
        $("#loader").removeAttr("style");
        $('.content').attr("style", 'display:none');
    }

    function terminarCargado() {
        $(".content").removeAttr("style");
        $('#loader').attr("style", 'display:none');
    }

    function logout() {
        localStorage.removeItem("token");
    }

    function verPerfil() {
        $('#containerNotas').hide();
        $('#containerAsistencia').hide();
        $('#containerPensul').hide();
        $("#containerPerfil").fadeIn();
        $('#bodyClick').click()
    }

    function verHistorial() {
        $('#containerNotas').hide();
        $('#containerAsistencia').hide();
        $('#containerPerfil').hide();
        $('#bodyClick').click()
        var isHistorialCargado = $('#isHistorialCargado').val();
        if (isHistorialCargado == 1) {
            $('#containerPensul').show();
            return;
        }
        comenzarCargado();
        var carreraId = $('#carrerasAlumno').find(":selected").val();
        $('#containerPensul').show();
        var usuario = new Object();
        usuario.pCarreraId = carreraId;
        var token = localStorage.getItem("token");
        if (token != '') {
            jQuery.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                'type': 'POST',
                'url': "http://wsnotas.nur.edu:8880/api/Registros/GetAlumnoHistorial",
                'dataType': 'json',
                'data': JSON.stringify(usuario),
                'success': carrgarHistorial,
                'error': errorSesion
            });
        }
        return false;
    }

    function carrgarHistorial(resultado) {
        var semestre = ' SEMESTRE';
        var espacio = ' - ';
        var arbol = [];
        resultado.Data.CURSADAS.forEach(function(element) {
            const {
                MATERIAS,
                REQUISITOS
            } = element;
            var materiaPadre = removerAcentos(MATERIAS.SMATERIA_DSC.toUpperCase()) + espacio + MATERIAS.LSEMESTRE + semestre;
            var count = 0;
            REQUISITOS.forEach(function(req) {
                if (req.LSEMESTRE == null)
                    return;
                var objNodo = new Object();
                var numeroSemestre = req.LSEMESTRE == null ? '' : req.LSEMESTRE;
                objNodo.from = removerAcentos(req.SMATERIA_DSC.toUpperCase()) + espacio + numeroSemestre + semestre;
                objNodo.to = materiaPadre;
                objNodo.value = 1;
                arbol.push(objNodo)
                count++;
            });
            if (count == 0) {
                var objNodo = new Object();
                var numeroSemestre = MATERIAS.LSEMESTRE;
                objNodo.from = removerAcentos(MATERIAS.SMATERIA_DSC.toUpperCase()) + espacio + MATERIAS.LSEMESTRE + semestre;
                objNodo.to = '';
                objNodo.value = 1;
                objNodo.semestre = MATERIAS.LSEMESTRE
                arbol.push(objNodo)
            }
        });
        resultado.Data.FALTANTES.forEach(function(element) {
            const {
                MATERIAS,
                REQUISITOS,
            } = element;
            var materiaPadre = removerAcentos(MATERIAS.SMATERIA_DSC.toUpperCase()) + espacio + MATERIAS.LSEMESTRE + semestre;
            var count = 0;
            REQUISITOS.forEach(function(req) {
                if (req.LSEMESTRE == null)
                    return;
                var objNodo = new Object();
                var numeroSemestre = req.LSEMESTRE == null ? '' : req.LSEMESTRE;
                objNodo.from = removerAcentos(req.SMATERIA_DSC.toUpperCase()) + espacio + numeroSemestre + semestre;
                objNodo.to = materiaPadre;
                objNodo.value = 1;
                objNodo.nodeColor = '#757575';
                arbol.push(objNodo);
                count++;
            });
            if (count == 0) {
                var objNodo = new Object();
                var numeroSemestre = MATERIAS.LSEMESTRE;
                objNodo.from = removerAcentos(MATERIAS.SMATERIA_DSC.toUpperCase()) + espacio + MATERIAS.LSEMESTRE + semestre;
                objNodo.to = '';
                objNodo.value = 1;
                objNodo.semestre = MATERIAS.LSEMESTRE
                arbol.push(objNodo)
            }
        });
        arbol.sort(function(a, b) {
            return parseInt(a.semestre) - parseInt(b.semestre);
        });
        am4core.useTheme(am4themes_animated);
        // Themes end
        var chart = am4core.create("chartdiv", am4charts.SankeyDiagram);
        chart.hiddenState.properties.opacity = 0; // this creates initial fade-in
        chart.data = arbol;
        let hoverState = chart.links.template.states.create("hover");
        hoverState.properties.fillOpacity = 0.6;
        chart.dataFields.fromName = "from";
        chart.dataFields.toName = "to";
        chart.dataFields.value = "value";
        chart.dataFields.color = "nodeColor";
        // for right-most label to fit
        chart.paddingRight = 30;
        // make nodes draggable
        var linkTemplate = chart.links.template;
        linkTemplate.controlPointDistance = 0.01;
        var nodeTemplate = chart.nodes.template;
        nodeTemplate.nameLabel.width = 380;
        nodeTemplate.inert = true;
        nodeTemplate.readerTitle = "Drag me!";
        nodeTemplate.showSystemTooltip = true;
        nodeTemplate.width = 380;
        nodeTemplate.nameLabel.locationX = 0.01;
        // make nodes draggable
        var nodeTemplate = chart.nodes.template;
        nodeTemplate.readerTitle = "Click to show/hide or drag to rearrange";
        nodeTemplate.showSystemTooltip = true;
        nodeTemplate.cursorOverStyle = am4core.MouseCursorStyle.pointer
        terminarCargado();
        $('#isHistorialCargado').val(1);
    }
    $(document).ready(function() {
        var esconderPeriodos = false;
        cargarPagina();
        $("#carrerasAlumno").change(function() {
            localStorage.setItem("carreraId", this.value);
            localStorage.setItem("carreraNombre",  $(this).find("option:selected").text());
            
            if ($('#containerPensul').is(":visible")) {
                $('#isHistorialCargado').val(0)
                verHistorial()

            }
            $('#verMasPeriodos').remove();
            $('.periodosInvisibles').remove();
            comenzarMainCargado();
            $('#firstLoad').val('1');
            cargarPagina();
        });

        function errorSesion() {
            localStorage.removeItem("token");
            var url = '../index.html'
            $(location).attr("href", url);
        }

        function comenzarMainCargado() {
            $('#mainContainer').attr("style", 'display:none');
            $("#mainLoader").removeAttr("style");
        }
        // $("#logout").click(function() {
        //     
        //     localStorage.removeItem("token");
        //     window.location = "../index.html";
        //     return false;
        // });
        $("#closePensul").click(function() {
            $('#containerNotas').show();
            $('#containerAsistencia').show();
            $('#containerPensul').hide();
        });
        $("#formCambiarPin").submit(function(event) {
            var pinAnterior = $("#pinAnterior").val();
            var nuevoPin = $("#nuevoPin").val();
            var repetirNuevoPin = $("#repetirNuevoPin").val();
            
            if (nuevoPin.localeCompare(repetirNuevoPin) == 0) {
                swal({
                    title: "Â¿Estas seguro de cambiar tu Pin ?",
                    type: "warning",
                    text: "Cambiara tu contraseÃ±a para ingresar al sitio de notas y para conectarte al Wi-Fi de la universidad",
                    showCancelButton: true,
                    confirmButtonText: "Aceptar",
                    cancelButtonText: "Cancelar"
                }).then((result) => {
                    var token = localStorage.getItem("token");
                    var usuario = new Object();
                    usuario.pPinActual = pinAnterior;
                    usuario.pPinNuevo = nuevoPin;
                    $.ajax({
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        'type': 'POST',
                        'data': JSON.stringify(usuario),
                        'url': "http://wsnotas.nur.edu:8880/api/Registros/UpdatePin",
                        'dataType': 'json',
                    }).done(function(response) {
                        if (response.Status) {
                            swal(
                                'Operacion Exitosa!',
                                'Pin actualizado correctamente!',
                                'success'
                            )
                        } else {
                            swal("Error", "Hubo un error al actualizar su Pin", "error")
                        }
                    });
                })
            } else {
                swal("Error", "Los Pines no son iguales.", "error")
            }
            $('#modalCambiarPin').modal('hide')
            $('#formCambiarPin')[0].reset();
            return false;
        });
        $("#verOferta").click(function() {
            var periodoOferta = $('#periodosOferta').find(":selected").val();
            var carreraId = $('#carrerasAlumno').find(":selected").val();
            localStorage.setItem("periodoOferta", periodoOferta);
            localStorage.setItem("carreraId", carreraId);
            $('#modalOferta').modal('hide')
            window.location = "oferta.html";
        });

        function removerAcentos(newStringComAcento) {
            var string = newStringComAcento;
            var mapaAcentosHex = {
                a: /[\xE0-\xE6]/g,
                A: /[\xC0-\xC6]/g,
                e: /[\xE8-\xEB]/g,
                E: /[\xC8-\xCB]/g,
                i: /[\xEC-\xEF]/g,
                I: /[\xCC-\xCF]/g,
                o: /[\xF2-\xF6]/g,
                O: /[\xD2-\xD6]/g,
                u: /[\xF9-\xFC]/g,
                U: /[\xD9-\xDC]/g,
                c: /\xE7/g,
                C: /\xC7/g,
                n: /\xF1/g,
                N: /\xD1/g
            };
            for (var letra in mapaAcentosHex) {
                var expressaoRegular = mapaAcentosHex[letra];
                string = string.replace(expressaoRegular, letra);
            }
            return string;
        }
        $(document).on('click', '#verMasPeriodos', function() {
            if (esconderPeriodos == false) {
                $('.periodosInvisibles').removeAttr("style");
                $(this).children().text('Ver Menos Periodos');
                esconderPeriodos = true;
            } else {
                $('.periodosInvisibles').attr("style", 'display:none');
                $(this).children().text('Ver Mas Periodos');
                esconderPeriodos = false;
            }
        });
        $(document).on('click', '.semestre', function() {
            comenzarCargado();
            $('#containerNotas').show();
            $('#containerAsistencia').show();
            var id = parseInt(JSON.parse($(this).attr('data-json')))
            var dperiodoActual = $(this).children("p").text();
            $('#containerPensul').hide();
            $('#containerPerfil').hide();
            $('#periodoActual').text(dperiodoActual);
            $('#dperiodoActual').val(dperiodoActual);
            $('#hperiodoActual').val(id);
            obtenerNotas(id);
        });

        function comenzarCargado() {
            $("#loader").removeAttr("style");
            $('.content').attr("style", 'display:none');
        }

        function terminarCargado() {
            $(".content").removeAttr("style");
            $('#loader').attr("style", 'display:none');
        }

        function terminarMainCargado() {
            $('#mainLoader').attr("style", 'display:none');
            $("#mainContainer").removeAttr("style");
        }

        function cargarPagina() {
            var token = localStorage.getItem("token");
            var tieneBloqueo = parseInt(localStorage.getItem("tieneBloqueo"));
            obtenerNombre(token);
            obtenerImagen(token);          
            getCarreraInfo(token);
            GetPeriodosOfertas();
            if(tieneBloqueo==0)
            {
                GetPeriodosCursados();  
            }
            else
            {
                $('#titlePeriodos').remove();
                $('#containerNotas').remove();
                $('#containerAsistencia').remove();
                $("#containerDeuda").removeAttr("style");
                $('#containerDeuda').fadeIn();
            }
            
        }
        

        function resultadoBloqueo(resultado) {
            var data = resultado.Data.toLowerCase();
            if(data.inclues(bloqueo))
            cargarCreditos(LHORASERVICIO);
        }
        function cargarCreditos(creditosVencidos) {
            am4core.useTheme(am4themes_animated);
            // Themes end
            var chart = am4core.create("divCreditos", am4charts.PieChart);
            chart.hiddenState.properties.opacity = 0; // this creates initial fade-in
            chart.data = [{
                country: "Realizadas",
                value: creditosVencidos
            }, {
                country: "Restantes",
                value: horasServicio - creditosVencidos
            }];
            chart.radius = am4core.percent(70);
            chart.innerRadius = am4core.percent(40);
            chart.startAngle = 180;
            chart.endAngle = 360;
            var series = chart.series.push(new am4charts.PieSeries());
            series.dataFields.value = "value";
            series.dataFields.category = "country";
            series.slices.template.cornerRadius = 10;
            series.slices.template.innerCornerRadius = 7;
            series.slices.template.draggable = true;
            series.slices.template.inert = true;
            series.alignLabels = false;
            series.hiddenState.properties.startAngle = 90;
            series.hiddenState.properties.endAngle = 90;
            chart.legend = new am4charts.Legend();
        }

        function obtenerImagen(token) {
            if (token != '') {
                $.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    'type': 'POST',
                    'url': "http://wsnotas.nur.edu:8880/api/Registros/GetAlumnoImagen",
                    'dataType': 'json',
                    'success': cargarImagem,
                    'error': errorSesion
                });
            }
        }

        function cargarImagem(resultado) {
            var imagen = 'data:image/png;base64,' + resultado.Data;
            $("#imgUsuario").attr("src", imagen);
        }

        function obtenerNombre(token) {
            if (token != '') {
                $.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    'type': 'POST',
                    'url': "http://wsnotas.nur.edu:8880/api/Registros/GetAlumnoInfo",
                    'dataType': 'json',
                    'success': resultado,
                    'error': errorSesion
                });
            }
        }

        function resultado(resultado) {
            const {
                SAPELLIDOP,
                SAPELLIDOM,
                SNOMBRES,
                SCELULAR,
                STELEFONO,
                SEMAIL,
                LHORASERVICIO,
            } = resultado.Data;
            var NombreCompleto = SNOMBRES + ' ' + SAPELLIDOP + ' ' + SAPELLIDOM
            $('#nombreEstudiante').text(NombreCompleto)
            $('#inputTelefono').val(STELEFONO);
            $('#inputCelular').val(SCELULAR);
            $('#inputEmail').val(SEMAIL);
            $('#tituloNombreEstudiante').text(NombreCompleto);
            cargarCreditos(LHORASERVICIO);
        }

        function getCarreraInfo(token) {
            if (token != '') {
                jQuery.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    'type': 'POST',
                    'url': "http://wsnotas.nur.edu:8880/api/Registros/GetAlumnoCarreras",
                    'dataType': 'json',
                    'success': infoCarrera,
                    'error': errorSesion
                });
            }
        }

        function infoCarrera(resultado) {
            var count = 0;
            //$('#carrerasAlumno').empty();
            var carreras = '';
            resultado.Data.forEach(function(element) {
                const {
                    LCARRERA_ID,
                    SCARRERA_DSC,
                    LPERIODOACTUAL,
                    LPERIODOACTUAL_ID
                } = element;
                $('#MasterPeriodoActual').val(LPERIODOACTUAL_ID);
                localStorage.setItem("MasterPeriodoActual", LPERIODOACTUAL_ID);
                $('#hperiodoActual').val(LPERIODOACTUAL_ID);
                $('#dperiodoActual').val(LPERIODOACTUAL)
                $('#periodoActual').text(LPERIODOACTUAL)
                if (count == 0) {
                    obtenerNotas(LPERIODOACTUAL_ID);
                    if ($('#firstLoad').val() == 1) {
                        return;
                    }
                };
                var opcion = $("<option></option>")
                opcion.attr("value", LCARRERA_ID);
                opcion.text(SCARRERA_DSC);
                $('#carrerasAlumno').append(opcion);
                if (carreras == ''){
                    localStorage.setItem("carreraId", LCARRERA_ID);
                    localStorage.setItem("carreraNombre", SCARRERA_DSC);
                    carreras += SCARRERA_DSC;
                }
                else{
                    carreras += ' , ' + SCARRERA_DSC;
                }                  
                count++;
            });
            $('#carreraPerfil').text(carreras)
        }

        function GetPeriodosCursados() {
            $('.semestre').remove();
            var carreraId = $('#carrerasAlumno').find(":selected").val();
            var usuario = new Object();
            usuario.pCarreraId = carreraId;
            var token = localStorage.getItem("token");
            if (token != '') {
                jQuery.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    'type': 'POST',
                    'url': "http://wsnotas.nur.edu:8880/api/Registros/GetPeriodosCursados",
                    'dataType': 'json',
                    'data': JSON.stringify(usuario),
                    'success': periodosCursados,
                    'error': errorSesion
                });
            }
        }

        function periodosCursados(resultado) {
            var count = 0;
            var length = resultado.Data.length;
            resultado.Data.forEach(function(element) {
                const {
                    SPERIODO_DSC,
                    LPERIODO_ID
                } = element;
                if (length > 2) {
                    if (count == 0) {
                        var lista = $("<li></li>")
                        var link = $("<a></a>")
                        var parrafo = $("<p></p>").text("Ver mas Periodos");
                        parrafo.attr("style", 'margin-left:0px;text-align:center');
                        parrafo.attr("class", "periodos");
                        link.attr("id", "verMasPeriodos");
                        link.append(parrafo);
                        lista.append(link);
                        $("#periodosTitle").after(lista);
                    }
                    if (count >= length - 2) {
                        var lista = $("<li></li>")
                        var link = $("<a></a>")
                        var parrafo = $("<p></p>").text(SPERIODO_DSC);
                        parrafo.attr("class", "periodos");
                        link.attr("class", "semestre");
                        link.attr("data-json", LPERIODO_ID);
                        link.append(parrafo);
                        lista.append(link);
                        $("#periodosTitle").after(lista);
                    }
                    if (count < length - 2) {
                        var lista = $("<li></li>")
                        var link = $("<a></a>")
                        var parrafo = $("<p></p>").text(SPERIODO_DSC);
                        parrafo.attr("class", "periodos");
                        link.attr("class", "semestre");
                        link.attr("data-json", LPERIODO_ID);
                        link.append(parrafo);
                        lista.append(link);
                        lista.attr("style", 'display:none');
                        lista.attr("class", "periodosInvisibles");
                        $("#periodosTitle").after(lista);
                    }
                } else {
                    var lista = $("<li></li>")
                    var link = $("<a></a>")
                    var parrafo = $("<p></p>").text(SPERIODO_DSC);
                    parrafo.attr("class", "periodos");
                    link.attr("class", "semestre");
                    link.attr("data-json", LPERIODO_ID);
                    link.append(parrafo);
                    lista.append(link);
                    $("#periodosTitle").after(lista);
                }
                count++;
            });
        }

        function GetPeriodosOfertas() {
            var carreraId = $('#carrerasAlumno').find(":selected").val();
            var usuario = new Object();
            usuario.pCarreraId = carreraId;
            var token = localStorage.getItem("token");
            if (token != '') {
                jQuery.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    'type': 'POST',
                    'url': "http://wsnotas.nur.edu:8880/api/Registros/GetPeriodosOferta",
                    'dataType': 'json',
                    'data': JSON.stringify(usuario),
                    'success': periodosOfertas,
                    'error': errorSesion
                });
            }
        }

        function periodosOfertas(resultado) {
            for (i in resultado.Data) {
                var element = resultado.Data[i];
                const {
                    SPERIODO_DSC,
                    LPERIODO_ID
                } = element;
                var opcion = $("<option></option>")
                opcion.attr("value", LPERIODO_ID);
                opcion.text(SPERIODO_DSC);
                $('#periodosOferta').append(opcion);
            }
            // resultado.Data.forEach(function(element) {
            //     const {
            //         SPERIODO_DSC,
            //         LPERIODO_ID
            //     } = element;
            //      
            //     //Menu Lateral
            //     var lista = $("<li></li>")
            //     var link = $("<a></a>")
            //     var parrafo = $("<p></p>").text(SPERIODO_DSC);
            //     parrafo.attr("class", "periodos");
            //     link.attr("class", "semestre");
            //     link.attr("data-json", LPERIODO_ID);
            //     link.append(parrafo);
            //     lista.append(link);
            //     $("#SPERIODO_DSC").after(lista);
            // });
        }

        function obtenerNotas(periodoId) {
            var periodoActual = $('#dperiodoActual').val();
            var semestre = periodoActual.split("-")[1];
            var tieneBloqueo = parseInt(localStorage.getItem("tieneBloqueo"));
            if(tieneBloqueo==0)
            {
                mostrarColumnas(semestre);
            }          
            var token = localStorage.getItem("token");
            var carreraId = $('#carrerasAlumno').find(":selected").val();
            var userId = localStorage.getItem("idUser");
            var usuario = new Object();
            usuario.pCarreraId = carreraId;
            usuario.pPeriodoId = periodoId;
            if (userId != '') {
                jQuery.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    'type': 'POST',
                    'data': JSON.stringify(usuario),
                    'url': "http://wsnotas.nur.edu:8880/api/Registros/GetNotasFaltas",
                    'dataType': 'json',
                    'success': cargarNotas,
                    'error': errorSesion
                });
            }
        }

        function mostrarColumnas(semestre) {
            switch (semestre) {
                case '1':
                    $(".firstSemester").removeAttr("style");
                    if (!$('.secondSemester')[0].hasAttribute('style')) {
                        $('.secondSemester').attr("style", 'display:none');
                    }
                    if (!$('.verano')[0].hasAttribute('style')) {
                        $('.verano').attr("style", 'display:none');
                    }
                    break;
                case '2':
                    $(".secondSemester").removeAttr("style");
                    if (!$('.firstSemester')[0].hasAttribute('style')) {
                        $('.firstSemester').attr("style", 'display:none');
                    }
                    if (!$('.verano')[0].hasAttribute('style')) {
                        $('.verano').attr("style", 'display:none');
                    }
                    break;
                case 'V':
                    $(".verano").removeAttr("style");
                    if (!$('.secondSemester')[0].hasAttribute('style')) {
                        $('.secondSemester').attr("style", 'display:none');
                    }
                    if (!$('.firstSemester')[0].hasAttribute('style')) {
                        $('.firstSemester').attr("style", 'display:none');
                    }
                    break;
            }
        }

        function cargarNotas(resultado) {
            $('#tablaNotas').empty();
            $('#tablaAsistencia').empty();
            resultado.Data.forEach(function(element) {
                const {
                    SCODMATERIA,
                    SSIGLA,
                    DOCENTE,
                    EXFINAL,
                    FINAL,
                    PAR1,
                    PAR2,
                    SMATERIA_DSC,
                    LCENTRO_ID
                } = element;
                var tr = $("<tr ></tr>")
                var tdCodMateria = $("<td></td>").text(SCODMATERIA);
                var tdMateria = $("<td></td>").text(SMATERIA_DSC);
                var tdCodgrupo = $("<td></td>").text(SSIGLA);
                var tdDocente = $("<td></td>").text(DOCENTE);
                var tdExFinal = $("<td></td>").text(EXFINAL);
                var tdFinal = $("<td></td>").text(FINAL);
                var tdPar1 = $("<td></td>").text(PAR1);
                var tdPar2 = $("<td></td>").text(PAR2);
                tr.append(tdCodMateria)
                tr.append(tdMateria)
                tr.append(tdCodgrupo)
                tr.append(tdDocente)
                tr.append(tdPar1)
                tr.append(tdPar2)
                tr.append(tdExFinal)
                tr.append(tdFinal)
                $('#tablaNotas').append(tr);
                cargarAsistencias(element)
            });
        }

        function cargarAsistencias(element) {
            const {
                SCODMATERIA,
                SSIGLA,
                DOCENTE,
                SMATERIA_DSC,
                LCENTRO_ID
            } = element;
            var tr = $("<tr ></tr>")
            var tdCodMateria = $("<td></td>").text(SCODMATERIA);
            var tdMateria = $("<td></td>").text(SMATERIA_DSC);
            var tdCodgrupo = $("<td></td>").text(SSIGLA);
            var tdDocente = $("<td></td>").text(DOCENTE);
            tr.append(tdCodMateria)
            tr.append(tdMateria)
            tr.append(tdCodgrupo)
            tr.append(tdDocente)
            var periodoActual = $('#dperiodoActual').val();
            var semestre = periodoActual.split("-")[1];
            var count = 0;
            switch (semestre) {
                case '1':
                    const {
                        FMES3,
                        FMES4,
                        FMES5,
                        FMES6,
                        FMES7
                    } = element;
                    var tdFMES3 = $("<td></td>").text(FMES3);
                    var tdFMES4 = $("<td></td>").text(FMES4);
                    var tdFMES5 = $("<td></td>").text(FMES5);
                    var tdFMES6 = $("<td></td>").text(FMES6);
                    var tdFMES7 = $("<td></td>").text(FMES7);
                    tr.append(tdFMES3)
                    tr.append(tdFMES4)
                    tr.append(tdFMES5)
                    tr.append(tdFMES6)
                    tr.append(tdFMES7)
                    count = FMES3 + FMES4 + FMES5 + FMES6 + FMES7
                    if (LCENTRO_ID == 1) {
                        if (count == 3 || count == 4) {
                            tr.css("background-color", "yellow");
                        } else if (count == 5) {
                            tr.css("background-color", "red");
                        } else if (count > 5) {
                            tr.css("background-color", "black");
                            tr.css("color", "white");
                        }
                    } else if (LCENTRO_ID == 2) {
                        if (count == 1) {
                            tr.css("background-color", "yellow");
                        } else if (count == 2) {
                            tr.css("background-color", "red");
                        } else if (count > 2) {
                            tr.css("background-color", "black");
                            tr.css("color", "white");
                        }
                    }
                    break;
                case '2':
                    const {
                        FMES8,
                        FMES9,
                        FMES10,
                        FMES11,
                        FMES12
                    } = element;
                    var tdFMES8 = $("<td></td>").text(FMES8);
                    var tdFMES9 = $("<td></td>").text(FMES9);
                    var tdFMES10 = $("<td></td>").text(FMES10);
                    var tdFMES11 = $("<td></td>").text(FMES11);
                    var tdFMES12 = $("<td></td>").text(FMES12);
                    tr.append(tdFMES8)
                    tr.append(tdFMES9)
                    tr.append(tdFMES10)
                    tr.append(tdFMES11)
                    tr.append(tdFMES12)
                    count = FMES8 + FMES9 + FMES10 + FMES11 + FMES12
                    if (LCENTRO_ID == 1) {
                        if (count == 3 || count == 4) {
                            tr.css("background-color", "yellow");
                        } else if (count == 5) {
                            tr.css("background-color", "red");
                        } else if (count > 5) {
                            tr.css("background-color", "black");
                            tr.css("color", "white");
                        }
                    } else if (LCENTRO_ID == 2) {
                        if (count == 1) {
                            tr.css("background-color", "yellow");
                        } else if (count == 2) {
                            tr.css("background-color", "red");
                        } else if (count > 2) {
                            tr.css("background-color", "black");
                            tr.css("color", "white");
                        }
                    }
                    break;
                case 'V':
                    const {
                        FMES1,
                        FMES2
                    } = element;
                    var tdFMES1 = $("<td></td>").text(FMES1);
                    var tdFMES2 = $("<td></td>").text(FMES2);
                    tr.append(tdFMES1)
                    tr.append(tdFMES2)
                    count = FMES1 + FMES2
                    if (LCENTRO_ID == 1) {
                        if (count == 3 || count == 4) {
                            tr.css("background-color", "yellow");
                        } else if (count == 5) {
                            tr.css("background-color", "red");
                        } else if (count > 5) {
                            tr.css("background-color", "black");
                            tr.css("color", "white");
                        }
                    } else if (LCENTRO_ID == 2) {
                        if (count == 1) {
                            tr.css("background-color", "yellow");
                        } else if (count == 2) {
                            tr.css("background-color", "red");
                        } else if (count > 2) {
                            tr.css("background-color", "black");
                            tr.css("color", "white");
                        }
                    }
                    break;
            }
            $('#tablaAsistencia').append(tr);
            terminarCargado();
            terminarMainCargado();
        }
    });
</script>

</html>